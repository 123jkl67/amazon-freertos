################################################################
# Package cbmc, cbmc-batch, cbmc-viewer, and freertos and copy to S3
# for the purpose of running cbmc-batch on freertos.
#
# The packages cbmc, cbmc-batch, cbmc-viewer, and freertos change over
# time as we fix bugs and modify the freertos source for model
# checking.  We want to be able to reproduce results, which requires
# keeping track of which versions of the packages were used to produce
# the results.  This makefile builds dated tarfiles that can be
# referenced when invoking cbmc-batch.

FREERTOS = ${HOME}/freertos
DATE=$(shell date +%Y%m%d)

# CBMC

CBMC_PKG=cbmc-$(DATE)
CBMC_ROOT=~/cbmc
CBMC_S3=s3://cbmc/package

# CBMC Batch

BATCH_PKG=cbmc-batch-$(DATE)
BATCH_ROOT=~/cbmc-batch
BATCH_S3=s3://cbmc/package

# CBMC Viewer

VIEWER_PKG=cbmc-viewer-$(DATE)
VIEWER_ROOT=~/cbmc-viewer
VIEWER_S3=s3://cbmc/package

# FreeRTOS

FREERTOS_PKG=freertos-$(DATE)
FREERTOS_ROOT=$(abspath $(FREERTOS))
FREERTOS_S3=s3://cbmc

# CBMC

cbmc-clean:
	$(RM) /tmp/$(CBMC_PKG).tar.gz
	$(RM) -r /tmp/cbmc

cbmc-package:
	mkdir -p /tmp/cbmc
	cd $(CBMC_ROOT)/src; \
	cp \
		cbmc/cbmc \
		goto-cc/goto-cc \
		goto-instrument/goto-instrument \
		goto-analyzer/goto-analyzer \
		goto-diff/goto-diff \
			/tmp/cbmc
	tar fcz /tmp/$(CBMC_PKG).tar.gz -C /tmp cbmc


cbmc-install: cbmc-clean cbmc-package
	aws s3 cp /tmp/$(CBMC_PKG).tar.gz $(CBMC_S3)/

# CBMC Batch

batch-clean:
	$(RM) -r /tmp/cbmc-batch
	$(RM) /tmp/$(BATCH_PKG).tar.gz

batch-package:
	mkdir -p /tmp/cbmc-batch
	cp $(BATCH_ROOT)/bin/* /tmp/cbmc-batch
	tar fcz /tmp/$(BATCH_PKG).tar.gz -C /tmp --exclude .git cbmc-batch

batch-install: batch-clean batch-package
	aws s3 cp /tmp/$(BATCH_PKG).tar.gz $(BATCH_S3)/

# CBMC Viewer

viewer-clean:
	$(RM) -r /tmp/cbmc-viewer
	$(RM) /tmp/$(VIEWER_PKG).tar.gz

viewer-package:
	mkdir -p /tmp/cbmc-viewer
	cp $(VIEWER_ROOT)/* /tmp/cbmc-viewer
	tar fcz /tmp/$(VIEWER_PKG).tar.gz -C /tmp --exclude .git cbmc-viewer

viewer-install: viewer-clean viewer-package
	aws s3 cp /tmp/$(VIEWER_PKG).tar.gz $(VIEWER_S3)/

# FreeRTOS

NAME=$(notdir $(FREERTOS_ROOT))

freertos-clean:
	$(RM) /tmp/$(FREERTOS_PKG).tar.gz

freertos-package:
	tar fcz /tmp/$(FREERTOS_PKG).tar.gz \
		-C $(FREERTOS_ROOT)/.. \
		--exclude $(NAME)/verification \
		--exclude .git \
		$(NAME)

freertos-install: freertos-clean freertos-package
	aws s3 cp /tmp/$(FREERTOS_PKG).tar.gz $(FREERTOS_S3)/
